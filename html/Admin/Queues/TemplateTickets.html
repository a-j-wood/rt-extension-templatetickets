<%doc>
List the ticket templates associated with a queue, add a new one, or edit an
existing one.
</%doc>
\
<%ARGS>
$id
$Ticket => undef
$CreateTemplate => undef
</%ARGS>
\
<%INIT>
my $QueueObj = RT::Queue->new( $session{'CurrentUser'} );
$QueueObj->Load($id);

if ( !$QueueObj->id ) {
    Abort( loc( "Queue [_1] not found", $id ) );
}

if (not(   $QueueObj->CurrentUserHasRight('ShowTicketTemplate')
        || $QueueObj->CurrentUserHasRight('ModifyTicketTemplate') )
   )
{
    Abort( loc('Permission denied') );
}

my @MainFields = (
    'Subject',   'Content', 'Priority', 'FinalPriority',
    'Requestor', 'CC',      'AdminCC'
);
my @DefaultFields      = ( 'Subject', 'Content' );
my @ChildFields        = ( 'Queue',   @MainFields );
my @DefaultChildFields = ( 'Queue',   'Subject', 'Content' );

my @Results = ();

my $Title = loc( 'Template tickets for queue [_1]', $QueueObj->Name );

my $TicketObj = undef;
if ($Ticket) {
    $TicketObj = RT::Ticket->new( $session{'CurrentUser'} );
    $TicketObj->Load($Ticket);
    if ( not $TicketObj->id ) {
        push @Results, loc( 'Ticket [_1] not found', $Ticket );
        $Ticket         = undef;
        $TicketObj      = undef;
        $CreateTemplate = 0;
    } elsif ( not $TicketObj->CurrentUserHasRight('ShowTicket') ) {
        push @Results, loc('No permission to view ticket');
        $Ticket         = undef;
        $TicketObj      = undef;
        $CreateTemplate = 0;
    } elsif ( $TicketObj->Queue != $QueueObj->id ) {
        push @Results,
            loc( 'Ticket [_1] is not in queue [_2]',
            $Ticket, $QueueObj->Name || $id );
        $Ticket         = undef;
        $TicketObj      = undef;
        $CreateTemplate = 0;
    } elsif ( $CreateTemplate
        && not $QueueObj->CurrentUserHasRight('ModifyTicketTemplate') )
    {
        push @Results,
            loc( 'No permission to modify ticket templates in queue [_1]',
            $QueueObj->Name );
        $Ticket         = undef;
        $TicketObj      = undef;
        $CreateTemplate = 0;
    } elsif ($CreateTemplate) {
        $Title = loc( 'Create new template ticket for queue [_1]',
            $QueueObj->Name );
    } else {
        $Title = loc( 'Queue [_1]: Template ticket #[_2]: [_3]',
            $QueueObj->Name, $TicketObj->id, $TicketObj->Subject );
    }
}

my $TemplateSettings = {};
my $TemplateSummary  = '';
my $TemplateContent  = '';

if ($TicketObj) {
    my $ReadonlyTicketObj = {%$TicketObj};
    bless( $ReadonlyTicketObj, ref $TicketObj );

    $ReadonlyTicketObj->{'CurrentUserCanSetOwner'} = sub { return 0; };
    $ReadonlyTicketObj->{'CurrentUserHasRight'}    = sub { return 0; };

    my $TicketHistory = $ReadonlyTicketObj->SortedTransactions;
    $TicketHistory->RowsPerPage(1);

    $TemplateSummary = $m->scomp( '/Ticket/Elements/ShowSummary',
        'Ticket' => $ReadonlyTicketObj );

    $TemplateSummary =~ s/<form.*?<\/form>//sig;
    $TemplateSummary =~ s/<span\b[^>]*?\bclass=[^>]*?create.*?<\/span>//sig;

    $TemplateContent = $m->scomp(
        '/Elements/ShowHistory',
        'Object'       => $ReadonlyTicketObj,
        'Transactions' => $TicketHistory,
        'Attachments' =>
            $ReadonlyTicketObj->Attachments( 'WithHeaders' => 0 ),
        'AttachmentContent' => $ReadonlyTicketObj->TextAttachments,
        'ShowHeaders'       => 0,
        'ShowTitle'         => 0,
        'ShowDisplayModes'  => 0,
        'PathPrefix'        => RT->Config->Get('WebPath') . '/Ticket/'
    );

    $TemplateContent =~ s/<!--\b.*?-->//sg;
    $TemplateContent =~ s/<span\b[^>]*?\bclass=[^>]*?actions.*$//mig;

    my $Attribute = $TicketObj->FirstAttribute('TemplateTicketsDefinition');
    $TemplateSettings = $Attribute->Content || {} if ( defined $Attribute );

    # TODO: update settings when appropriate

}
</%INIT>
\
<& /Admin/Elements/Header, Title => $Title &>
<& /Elements/Tabs &>
<& /Elements/ListActions, actions => \@Results &>

% if ($Ticket) {
\
<&| /Widgets/TitleBox, title => loc('Template ticket configuration') &>
TODO: edit template ticket or create a new one
</&>

<div><hr /></div>

<h2><a target="_blank" href="<% RT->Config->Get('WebPath') %>/Ticket/Display.html?id=<% $TicketObj->id %>"><&|/l, $TicketObj->Id, $TicketObj->Subject &>#[_1]: [_2]</&></a></h2>

<&| /Widgets/TitleBox, title => loc('Template ticket summary') &>
<p>
<&|/l&>This is just a read-only summary.  Open the original ticket to change the details below.</&>
</p>
<p>
<a class="button" target="_blank" href="<% RT->Config->Get('WebPath') %>/Ticket/Display.html?id=<% $TicketObj->id %>"><&|/l&>Open the original ticket</&></a>
</p>
<% $TemplateSummary |n %>
<% $TemplateContent |n %>
<script type="text/javascript">
jQuery(function () { 
    jQuery('div.ticket-info-requestor').remove();
    jQuery('div.ticket-info-reminders').remove();
});
</script>
</&>
\
% } else {
\
<&| /Widgets/TitleBox, title => loc('Template tickets') &>
TODO: list of template tickets
</&>
\
%     if ( $QueueObj->CurrentUserHasRight('ModifyTicketTemplate') ) {
<&| /Widgets/TitleBox, title => loc('Create a new template ticket') &>
<form action="TemplateTickets.html" method="post">
<input type="hidden" name="id" value="<% $id %>" />
<input type="hidden" name="CreateTemplate" value="1" />
<p>
<&|/l&>Create new template ticket from an existing ticket</&>:
<input type="text" size="8" data-autocomplete="Tickets" name="Ticket" />
<input type="submit" value="<&|/l&>Create</&>" />
</p>
</form>
</&>
%     }
\
% }
